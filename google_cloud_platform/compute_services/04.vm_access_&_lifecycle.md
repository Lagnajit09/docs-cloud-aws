# VM Access and Lifecycle in Google Compute Engine

This document explains **how you access a Virtual Machine (VM)** and **how a VM behaves throughout its entire lifecycle** in **Google Cloud Platform**.

---

## 1. What Does “VM Access” Mean?

**VM access** is how:

- Humans connect to a VM (SSH / RDP)
- Applications connect to a VM (network traffic)
- A VM accesses other GCP services (IAM)

Access is always controlled and **never open by default**.

---

## 2. Types of VM Access

There are **three major access categories**.

---

### 2.1 Human Access (Admin / Developer)

This is how **you log in** to a VM.

#### Linux VM

- Access method: **SSH**
- Default port: `22`

#### Windows VM

- Access method: **RDP**
- Default port: `3389`

```mermaid
graph TD
    User --> SSH[SSH / RDP]
    SSH --> VM
```

#### How SSH Access Works (Conceptually)

1. You authenticate using:

   - SSH key
   - OS Login (IAM-based)

2. Firewall allows the port
3. VM OS allows the user

> **Important:**
> Firewall rules alone do NOT grant access.
> OS authentication is always required.

---

### 2.2 Network Access (Application Traffic)

This is how **applications or users reach services running on the VM**.

Examples:

- HTTP (port 80)
- HTTPS (port 443)
- Custom app ports (e.g., 8080)

```mermaid
graph TD
    Internet --> Firewall
    Firewall --> VM
    VM --> Application
```

Access depends on:

- Firewall rules
- VM network interface
- Whether the VM has an external IP

---

### 2.3 VM → GCP Service Access (IAM)

VMs often need to access:

- Cloud Storage
- Databases
- Pub/Sub
- APIs

This is done using a **service account**, not passwords.

```mermaid
graph TD
    VM --> ServiceAccount
    ServiceAccount --> IAM
    IAM --> GCPService
```

This is **machine identity**, not human identity.

---

## 3. VM Lifecycle — High-Level View

A VM is **not static**. It moves through multiple **states** from creation to deletion.

```mermaid
graph TD
    Provisioning --> Staging
    Staging --> Running
    Running --> Stopping
    Stopping --> Terminated
    Terminated --> Deleted
```

But this is only the **simplified view**.
Let’s go deeper.

---

## 4. Full VM Lifecycle States (Beginner Explanation)

Below are **all VM states**, what they mean, and when they occur.

---

### 4.1 Provisioning

**What it means:**

- Google is allocating resources
- Disk is being attached
- Network is being prepared

```mermaid
graph TD
    CreateRequest --> Provisioning
```

You **cannot access** the VM yet.

---

### 4.2 Staging

**What it means:**

- VM exists
- OS is booting
- Startup scripts may run

```mermaid
graph TD
    Provisioning --> Staging
```

Think of this as:

> “The computer is turning on.”

---

### 4.3 Running

**What it means:**

- VM is fully operational
- OS is running
- Applications can serve traffic
- SSH / RDP works

```mermaid
graph TD
    Staging --> Running
```

This is the **normal active state**.

---

### 4.4 Repairing

**What it means:**

- VM failed health checks
- Google is attempting recovery
- Common in Managed Instance Groups

```mermaid
graph TD
    Running --> Repairing
    Repairing --> Running
```

Used mostly in **self-healing architectures**.

---

### 4.5 Suspending

**What it means:**

- VM memory (RAM) is saved
- CPU stops
- Disk remains attached

```mermaid
graph TD
    Running --> Suspending
```

Similar to **hibernation** on a laptop.

---

### 4.6 Suspended

**What it means:**

- VM is paused
- RAM snapshot stored
- Faster resume than start

```mermaid
graph TD
    Suspending --> Suspended
```

Billing:

- Storage charged
- No CPU charges

---

### 4.7 Stopping

**What it means:**

- OS shutdown is initiated
- Shutdown scripts run
- VM prepares to stop

```mermaid
graph TD
    Running --> Stopping
```

---

### 4.8 Terminated (Stopped)

**What it means:**

- VM is powered off
- Disk persists
- No CPU billing

```mermaid
graph TD
    Stopping --> Terminated
```

You can restart from here.

---

### 4.9 Deleted

**What it means:**

- VM is permanently removed
- Resources are released
- Boot disk may be deleted

```mermaid
graph TD
    Terminated --> Deleted
```

This is **irreversible**.

---

## 5. VM Lifecycle Actions (API / Console Actions)

Each state transition happens due to an **action**.

| Action               | Effect               |
| -------------------- | -------------------- |
| `instance.start()`   | Terminated → Running |
| `instance.stop()`    | Running → Terminated |
| `instance.reset()`   | Hard reboot          |
| `instance.suspend()` | Running → Suspended  |
| `instance.resume()`  | Suspended → Running  |
| `instance.delete()`  | Any → Deleted        |

---

## 6. Full VM Lifecycle Diagram (With Actions)

```mermaid
stateDiagram-v2
    [*] --> Provisioning
    Provisioning --> Staging
    Staging --> Running

    Running --> Repairing : health failure
    Repairing --> Running

    Running --> Stopping : instance.stop()
    Stopping --> Terminated

    Terminated --> Running : instance.start()

    Running --> Suspending : instance.suspend()
    Suspending --> Suspended
    Suspended --> Running : instance.resume()
    Suspended --> Deleted : instance.delete()

    Terminated --> Deleted : instance.delete()
```

---

## 7. Startup and Shutdown Scripts (Very Important)

These scripts **automate VM behavior**.

---

### 7.1 Startup Scripts

**When they run:**

- During **Staging**
- Every time VM starts or restarts

**Common uses:**

- Install packages
- Start services
- Pull code
- Configure applications

```mermaid
graph TD
    VMStart --> StartupScript
    StartupScript --> AppReady
```

Example:

- Install Nginx automatically

---

### 7.2 Shutdown Scripts

**When they run:**

- During **Stopping**
- Before VM terminates

**Common uses:**

- Graceful app shutdown
- Upload logs
- Notify systems

```mermaid
graph TD
    StopRequest --> ShutdownScript
    ShutdownScript --> VMStop
```

> Startup and shutdown scripts are defined using **VM metadata**.

---

## 8. Patch Activities (OS Updates & Maintenance)

### What is Patching?

Patching means:

- Updating OS packages
- Applying security fixes
- Fixing vulnerabilities

---

### 8.1 Manual Patching

You:

- SSH into VM
- Run OS update commands
- Restart services manually

Used in:

- Small systems
- Dev environments

---

### 8.2 Automated Patching

Google provides **OS Patch Management**:

- Schedule patch windows
- Apply updates automatically
- Generate reports

```mermaid
graph TD
    PatchSchedule --> VM
    VM --> UpdatedOS
```

Best practice:

> Patch regularly to avoid security risks.

---

### 8.3 Patch Impact on Lifecycle

- Patching may require:

  - Restart
  - Temporary downtime

- In MIGs, rolling updates are used

```mermaid
graph TD
    Patch --> Restart
    Restart --> Running
```

---
